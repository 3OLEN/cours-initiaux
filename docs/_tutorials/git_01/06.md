---
title: "Git - TP 1"
subtitle: "Scripting python"
permalink: /git/tp/1/page/6
---

# 1. Gestion des d√©pendances

Python utilise un gestionnaire de d√©pendances appel√© `pip`. Il r√©cup√®re les d√©pendances depuis le
[Python Package Index](https://pypi.org/), un d√©p√¥t centralis√© de paquets Python.

_Exemple d'usage_ :

```bash
python -m pip install SomePackage            # latest version
python -m pip install SomePackage==1.0.4     # specific version
python -m pip install 'SomePackage>=1.0.4'   # minimum version
```

Au sein d'un projet, on ne peut pas demander √† chaque membre de l'√©quipe d'installer les d√©pendances une √† une. Ce
serait une perte de temps et une source d'erreur (typo dans le nom du package ou num√©ro de version inexacte).

G√©n√©ralement, on utilise un fichier `requirements.txt` pour lister les d√©pendances du projet avec leurs versions. Or il
y a des fonctionnalit√©s que l'on retrouve dans d'autres gestionnaires qui ne sont pas disponibles dans `pip`, ou d'une
mani√®re d√©tourn√©e :

- Avec certains gestionnaires, on trouve un fichier `.lock` qui sp√©cifie les versions exactes des d√©pendances.
<br>Lorsque l'on souhaite installer toutes les d√©pendances, seules les versions exactes indiqu√©es dans ce fichier sont
install√©es, m√™me si la version poss√®de des mises √† jour disponibles.
<br>Cela √©vite d'avoir des diff√©rentiels de versions entre les membres de l'√©quipe et sur les environnements de
d√©ploiement.
- Certaines d√©pendances ne doivent √™tre install√©es que sur des environnements sp√©cifiques (ce qui est relatif aux tests
unitaires ne doit pas √™tre install√© sur l'environnement de `production`), ce que `pip` permet en partie de faire.

Nous allons utiliser un outil plus "sexy" et adapt√© : [Poetry](https://python-poetry.org/).

## 1.1. Installation de Poetry

{% assign resource_dockerfile_python = site.static_files | where: "name", "dockerfile-python-02" | first %}

1. Cr√©ez la branche `local-python-poetry`.
2. Remplacez le contenu du `Dockerfile` par le nouveau fourni :
   [dockerfile-python-02]({{ resource_dockerfile_python.path | relative_url }}).
   <br>On y a rajout√© l'installation de `Poetry` et l'ajout de variables d'environnement pour surcharger quelques
   configurations pour python et d'autres composants.
3. Faites un nouveau build de l'image.
4. Ex√©cutez un shell bash dans un container √† partir de l'image pour poursuivre la configuration de `Poetry`.
   <br>N'oubliez pas les bonnes options √† votre commande docker...
5. Ex√©cutez la commande `poetry about` pour v√©rifier que la librairie est bien install√©e.
6. Gr√¢ce aux commandes `poetry init` et `poetry lock`, g√©n√©rez les fichiers suivants :
   * `pyproject.toml` : Int√®gre les informations globales de votre "projet python" et permet de lister les d√©pendances.
   * `poetry.lock` : Indique les versions exactes des d√©pendances install√©es. C'est √† partir de ce fichier que tout un
     chacun pourra installer les bonnes d√©pendances python.
7. Ces fichiers ne sont disponibles que dans ce container. Faites en sorte de r√©cup√©rer ces fichiers ou leur contenu
   en local dans le dossier `docker/python`.

Vous devriez alors avoir trois fichiers dans le dossier `docker/python` de votre repository :
`Dockerfile`, `poetry.lock` et `pyproject.toml`.

## 1.2. Configuration de Poetry dans le Dockerfile

Afin de pouvoir utiliser la puissance du cache des images Docker, on va faire en sorte que les d√©pendances soient
install√©es directement √† la construction de l'image.

Rajoutez les instructions suivantes apr√®s les instructions sur l'utilisateur `cli` :

```Dockerfile
# Dependencies
COPY --chown=cli:cli ./docker/python/pyproject.toml ./docker/python/poetry.lock ./

RUN poetry install
```

La premi√®re instruction va faire une copie des deux nouveaux fichiers directement √† la racine du *workdir* de l'image.
Ils pourront alors √™tre utilis√©s tr√®s facilement par Poetry. On sp√©cifie aussi l'utilisateur propri√©taire de ces
fichiers. Dans le cas contraire, le propri√©taire aurait √©t√© `root` et √ßa aurait √©t√© tr√®s bloquant pour la suite.

Cette commande `COPY` v√©rifie aussi s'il y a un diff√©rentiel entre les fichiers sources et les fichiers cach√©s dans la
construction de l'image. S'il y a une diff√©rence, la prochaine construction de l'image n'utilisera pas le cache √† partir
de cette instruction, permettant alors de prendre en compte les modifications de ces fichiers.

Enfin, la deuxi√®me instruction permet d'installer dans l'image les d√©pendances d√©finies par les deux fichiers.

Une fois ce code rajout√© √† votre `Dockerfile`, construisez de nouveau l'image.

## 1.3. Utilisation de Poetry

Poetry va donc √™tre utilis√©e pour d√©finir les d√©pendances de notre utilitaire python √† travers les commandes
`poetry add <package>` ou `poetry remove <package>`.

Pour que python puisse ex√©cuter des scripts en utilisant les librairies install√©es, il sera n√©cessaire de passer
√©galement par le biais de Poetry avec la commande `poetry run python`. Ainsi, pour ex√©cuter un script
`hello_world.python`, on utilisera la commande `poetry run python hello_world.python` au lieu de
`python hello_world.python`.

Nous allons proc√©der √† quelques modifications au sein de nos scripts bash.

1. Cr√©ez le script bash `bin/env/poetry` en vous basant sur le script bash `bin/python`.
   * Ce script va v√©rifier √©galement que l'image existe, sinon il fera appel au script de setup.
   * Ce script va √©galement construire un container √† partir de l'image et va ex√©cuter la commande `poetry`.
   * Assurez-vous de bien prendre en compte les param√®tres fournis √† votre script.
2. Testez le script : `bin/env/poetry` ; vous devriez avoir la liste des commandes disponibles avec `poetry`.
3. Testez √©galement avec un param√®tre : `bin/env/poetry version` ; vous devriez avoir le nom de votre "projet" python
   et sa version (si vous avez gard√© les valeurs par d√©faut, ce devrait √™tre `scripts 0.1.0`).
4. Modifiez ensuite le script bahs `bin/python` afin d'ex√©cuter la commande `python` √† travers `poetry`, comme vu plus
   haut.
5. N'oubliez pas les petites modifications du `README.md`, puis commitez avec un message plus complet :
   ``````markdown
   üì¶Ô∏è [poetry] Installation

   üêã Docker
   =========

   * ‚ûï [python] `poetry` for dependency management

   üî® Scripting
   ============

   * ‚ú® [env::poetry] Provide access to `Poetry` tool
   * [.::python] Use `python` with `poetry`
   ``````
6. Pushez, puis faites la PR et **demandez-moi la review**.

# 2. Script python

Dans une nouvelle branche `local-python-monitoring`, vous allez cr√©er un script python :
`bin/src_python/system_monitoring.python` dont le but est d'afficher des informations de "system monitoring" telles que
l'utilisation CPU ou l'utilisation de la RAM.

Pour ce faire, vous utiliserez la librairie `psutil` qui permet d'acc√©der √† des informations syst√®me ; elle s'installe
de la mani√®re suivante : `poetry add psutil`.

Le script pourra alors √™tre ex√©cut√© de la sorte : `bin/python bin/src_python/system_monitoring.python`.

## ‚ö†Ô∏è Remarques

* Lorsqu'il y a une modification des d√©pendances, les fichiers `poetry.lock` et `pyproject.toml` sont modifi√©es.
  Ces-dites modifications devraient √©galement √™tre effectives sur les fichiers de votre repository. Sinon, il vous
  manque quelques options dans le `docker run` li√© √† l'utilisation de Poetry...
* Puisque les containers sont d√©truits apr√®s utilisation, toutes les modifications qui ne sont pas synchronis√©es avec
  votre local sont perdues, cela vaut pour l'installation des d√©pendances...
