---
title: "Git - TP 1"
subtitle: "Scripting avec Docker"
permalink: /git/tp/1/page/5
---

> Pour vous familiariser avec Docker, vous continuerez √† travailler en pair programming.

# Probl√©matique

Au sein d'un projet, l'√©quipe peut √™tre amen√©e √† n√©cessiter plusieurs outils, notamment par le biais de langages de
programmation : python, PHP, node.js, ruby, etc. Dans un environnement local, il devient rapidement difficile de g√©rer
tous ces outils, de les faire cohabiter, de les mettre √† jour, etc. d'autant plus lorsque les versions diff√®rent d'un
projet √† un autre.

Par ailleurs, il faut s'assurer que tous les membres de l'√©quipe utilisent exactement les m√™mes outils, que ce soit
pour les versions ou les d√©pendances (et leurs versions).

Les containers de Docker sont une solution √† cette probl√©matique par le biais de leur image qui peut √™tre facilement
partag√©e.

Vous allez cr√©er un container int√©grant python afin d'ex√©cuter les scripts python n√©cessaires pour le projet et
l'environnement local.

# Avant-propos : container python

Il existe une image officielle de python sur Docker Hub : [python](https://hub.docker.com/_/python), afin de cr√©er des
containers Docker "standalone" pour ex√©cuter des scripts python, ou pour s'en servir de base pour une image plus
√©toff√©e et sp√©cifique √† un besoin particulier.

```bash
docker run --rm -it python:3.12 python --version
```

La commande cr√©e un container anonyme √† partir de l'image `python` avec le tag `3.12` et ex√©cute la commande 
`python --version` √† l'int√©rieur du container.

* L'option `--rm` permet de supprimer le container une fois qu'il est arr√™t√©, pour √©viter d'avoir des containers
  inutiles qui utilisent de l'espace disque.
* L'option `-i` (raccourci de `--interactive`) permet d'interagir avec le container.
* L'option `-t` (raccourci de `--tty`) permet de cr√©er un pseudo-terminal pour le container.
* Ce sont les options de base et essentielles pour ex√©cuter des commandes dans un container.
<br>Dans ce cas de figure o√π on ex√©cute une commande qui ne n√©cessite pas d'interaction, on peut s'abstenir des options
`-it`.
<br>Si on avait voulu entrer dans le container pour ex√©cuter des commandes manuellement (avec la commande `python` ou
tout simplement la commande `bash`), on aurait eu besoin de ces options.

## Ex√©cuter des scripts python

Avec l'image que vous avez r√©cup√©r√©e, vous pouvez vous en servir pour construire des containers "standalone" qui
pourront ex√©cuter vos scripts python.

Admettons le script `hello_there.py` suivant :

```python
print("General Kenobi!")
```

Vous pourrez l'ex√©cuter avec la commande suivante :

```bash
docker run --rm -it -v $(pwd):/usr/src/app -w /usr/src/app python:3.12 python hello_there.py
```

* L'option `-v` (raccourci de `--volume`) permet de monter un volume dans le container.
<br>C'est-√†-dire qu'on va fournir un chemin local (directory ou fichier) que l'on va monter dans le container. Les deux
seront alors synchronis√©s.
<br>Ici, on monte le r√©pertoire courant (`$(pwd)`) dans le r√©pertoire `/usr/src/app` du container.
* L'option `-w` (raccourci de `--workdir`) permet de d√©finir le r√©pertoire courant du container lorsqu'on l'ex√©cute.
<br>Cela revient √† faire un `cd` vers le chemin indiqu√© avant d'ex√©cuter la commande demand√©e.
<br>Ici, on d√©finit le r√©pertoire courant du container √† `/usr/src/app`, l√† o√π on a mont√© le r√©pertoire courant local.

### D√©finir un utilitaire local

Pour simplifier l'ex√©cution de la commande, vous pouvez d√©finir un alias dans votre shell.

```bash
alias dpy='docker run --rm --interactive --tty --volume $(pwd):/usr/src/app --workdir /usr/src/app python:3.12 python'
alias dpyb='docker run --rm --interactive --tty --volume $(pwd):/usr/src/app --workdir /usr/src/app python:3.12 bash'
```

Ce qui vous permettra d'ex√©cuter une commande python ou un script de cette mani√®re : `dpy hello_there.py`.

Le deuxi√®me alias vous permettrait d'ex√©cuter un shell bash dans le container avec la commande `dpyb`.

> ‚ö†Ô∏è Si vous comptez √©crire des scripts python au lieu de scripts bash pour vous aider dans vos t√¢ches, je vous
> conseille toutefois √† installer directement python sur votre machine et √† l'utiliser au lieu de passer par Docker.
> <br>
> Ce n'est pas parce que vous en avez la possibilit√© qu'il faut le faire üòÑ Ce serait dommage de surcharger votre python
> avec du Docker et faire, potentiellement, face √† des probl√®mes divers et vari√©s.
> <br>
> Ce que vous allez faire au final dans ce TP, c'est de d√©finir une image sur-mesure pour votre projet.
> <br>
> Vous pouvez avoir un repository Git avec des scripts Python utiles pour une utilisation de tous les jours et ainsi
> d√©finir un container Docker sp√©cifique √† ce besoin avec une image bas√©e sur python et les d√©pendances n√©cessaires.
 
# 1. Cr√©ation de l'image

Les images Docker sont d√©finies par un fichier `Dockerfile` qui contient les instructions pour construire l'image. Vous
allez en faire une pour ce projet, qui sera tr√®s basique pour commencer.

## üìãÔ∏è Instructions

{% assign resource_dockerfile_python = site.static_files | where: "name", "dockerfile-python-01" | first %}

1. Cr√©ez la branche `docker-python`.
2. R√©cup√©rez le fichier : [dockerfile-python-01]({{ resource_dockerfile_python.path | relative_url }}).
3. D√©placez-le dans le dossier `docker/python` et renommez-le `Dockerfile`.
4. Positionnez votre terminal √† la racine du projet et construisez l'image Docker correspondante avec la commande
suivante :
   ```bash
   docker build \
     --file docker/python/Dockerfile \
     --tag 3olen/tp-git-1-python \
     .
   ```
<br>Vous avez maintenant une image Docker nomm√©e `3olen/tp-git-1-python` qui est construite √† partir du `Dockerfile`.
5. V√©rifiez que l'image est fonctionnelle avec un container :
   ```bash
   docker run --rm -it 3olen/tp-git-1-python python -c "print('Hello there!')"
   ```
6. Compl√©tez la liste de t√¢ches du `README.md` :
``````markdown
- [ ] **Python** : D√©finir des scripts utiles pour le projet.
  - [x] Utilisation de Docker.
  - [ ] Scripting Docker.
  - [ ] Gestion des d√©pendances.
  - [ ] Scripting projet.
``````
7. Commitez (message : `üêã [Python] Init image`), pushez, PR-ez, review-ez, mergez et nettoyez votre local.

# 2.1. Scripting Docker

Afin de faciliter l'utilisation des commandes Docker vues plus haut, vous allez d√©finir des scripts permettant
d'effectuer ces actions :

* `bin/setup/python` : Build l'image Docker `3olen/tp-git-1-python`.
* `bin/python` : Ex√©cute une commande python dans un container de l'image `3olen/tp-git-1-python`.
  - V√©rifiez que l'image existe. Si ce n'est pas le cas, faites appel au script de setup.
  - V√©rifiez qu'un argument est pass√© √† votre script afin de pouvoir le fournir √† la commande `python` du container :
  <br>`bin/python -c print('General Kenobi!')` devrait ex√©cuter la commande `python -c print('General Kenobi!')` dans
  le container.
  <br>Si vous faites preuve de curiosit√©, essayez de voir ce qu'il se passe si vous ne fournissez pas d'argument √† votre
  script.

> ‚ÑπÔ∏è Vous aurez besoin du `ROOT_PATH` comme d√©fini dans le script `bin/setup/hooks` pour manipuler correctement les
> chemins dans vos scripts (notamment pour le `docker build`).
 
## üìãÔ∏è Instructions

1. Cr√©ez la branche `local-python-docker`.
2. Cr√©ez les deux scripts d√©finis ci-dessus.
3. N'oubliez pas de cocher la t√¢che du `README.md`.
4. Compl√©tez les instructions du repository du `README.md` avec le contenu fourni ci-apr√®s.
5. Commitez, avec un message plus long et explicite :
   ``````markdown
   üî® [Python] Docker build / run
   
   üî® Scripting
   ============
   
   * ‚ú® [setup::python] Build docker image
   * ‚ú® [.::python] Execute python command in container
   ``````
6. Pushez, puis faites la PR et **demandez-moi la review**.

### üìù Contenu du `README.md` √† ajouter

```markdown
[//] <> (Dans la partie "### Setup du repository", √† la suite de la liste :)
* [bin/setup/python](bin/setup/python) : Build l'image Docker `3olen/tp-git-1-python`.

[//] <> (Juste en-dessous, d√©finissez une nouvelle sous-partie :)
### Utilitaires

Divers scripts sont d√©finis dans le dossier [bin](bin) (et √©ventuellement dans les sous-dossiers) pour faciliter
l'utilisation d'outils utiles au sein du repository.

* [bin/python](bin/python) : Ex√©cute une commande python dans le container de l'image `3olen/tp-git-1-python`.
```

# 2.2. Ex√©cution de scripts python

{% assign resource_script_assert_2 = site.static_files | where: "name", "assert-02-python-script" | first %}
{% assign resource_script_assert_py = site.static_files | where: "name", "assert-02a-hello_there.py" | first %}

Ex√©cuter des commandes python c'est bien, mais ex√©cuter des scripts c'est encore mieux ! Vous √™tes s√ªr que √ßa 
fonctionne ? On va v√©rifier √ßa avec un script "assert".

1. R√©cup√©rez le fichier : [assert-02-python-script]({{ resource_script_assert_2.path | relative_url }}).
2. D√©placez-le dans le dossier `bin/assert` de votre d√©p√¥t et renommez-le `02-python-script`.
3. Assurez-vous qu'il est bien ex√©cutable avec les commandes appropri√©es.
4. R√©cup√©rez le fichier : [assert-02a-hello_there.py]({{ resource_script_assert_py.path | relative_url }}).
5. D√©placez-le dans le dossier `bin/assert` de votre d√©p√¥t et renommez-le `02a-hello_there.py`.
6. Ex√©cutez le script `bin/assert/02-python-script` pour v√©rifier...

Normalement, vous devriez avoir un message d'erreur. C'est "normal", mais vous allez y rem√©dier !

## üìãÔ∏è Instructions

1. Cr√©ez la branche `local-python-script`.
2. Tentez d'ex√©cuter le script python : `bin/python bin/assert/02a-hello_there.py`.
3. Creusez un peu pour comprendre pourquoi √ßa ne fonctionne pas.
  - Fouillez dans le `Dockerfile`, vous comprendrez peut-√™tre certaines choses.
  - N'h√©sitez pas √† ex√©cuter un shell dans un container pour en apprendre plus :
  `docker run --rm -it 3olen/tp-git-1-python bash`
  - Un <em title="--volume">üîé indice</em> ?
4. Une fois le probl√®me corrig√©, commitez : `üî® [Python] Run python scripts`.
5. Pushez, puis faites la PR et **demandez-moi la review**.

# C'est tout ?

Non, il nous reste √† ajouter la gestion des d√©pendances python pour notre container et bien s√ªr √† d√©finir des scripts
utiles pour le projet afin que tout ceci n'ait pas √©t√© vain.
