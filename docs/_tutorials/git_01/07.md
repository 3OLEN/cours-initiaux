---
title: "Git - TP 1"
subtitle: "Images Docker"
permalink: /git/tp/1/page/7
---

Les images Docker permettent de d√©finir des environnements de travail qui sont ensuite impl√©ment√©s dans des containers.

C'est √† travers ces containers que vous pouvez manipuler ces environnements et ex√©cuter des commandes.

Les images que vous utilisez sont ensuite stock√©es sur votre machine.

# 1. üêã Commandes Docker des images

√Ä travers `Docker`, vous avez acc√®s √† plusieurs commandes ou outils pour g√©rer les images :

* `docker image` : Outil pour g√©rer les images :
    - `docker image ps` : Liste vos images locales.
    - `docker image pull` : R√©cup√®re une image d'un *registry*.
    - `docker image push` : Envoie l'image sur un *registry*.
    - `docker image remove` : Supprime une image locale par le biais de son identifiant.
    - `docker image prune` : Supprime les images *dangling* (en suspend) ou *unused* (inutilis√©es).
* `docker images` : Alias de `docker image ps`.
* `docker rmi` : Alias de `docker image remove`.

# 2. üóÉÔ∏è Liste des images

Afficher la liste de vos images locales. Vous aurez alors les informations suivantes : `nom`, `tag`, `ID hash`,
`date de cr√©ation` et `taille`.

Plus vous utilisez d'images Docker, plus elles prennent de la place sur votre machine. De plus, toutes les images qui
ont √©t√© "pr√©-construites" (build interrompu soit par une action manuelle, soit par une erreur de build) sont aussi
stock√©es sur votre machine. Cela peut prendre rapidement de l'espace de stockage, surtout si les images sont mal
optimis√©es et sont plus volumineuses qu'elles ne le devraient.

Vous aurez peut-√™tre plusieurs images nomm√©es `<none>`, ce sont g√©n√©ralement des images incompl√®tes cr√©√©es suite √† une
erreur de `build`.

# 3. üßπ Nettoyage

Docker met √† disposition la commande `docker image prune` qui vous permet de supprimer toutes les images *dangling*
(qui n'ont pas de nom). Vous pouvez aussi supprimer toutes les images inutilis√©es (qui n'ont pas de containers actifs),
avec l'option `--all`.

Ex√©cutez la commande `docker image prune` pour faire du bien √† votre stockage local.

# 4. üöÄ Push sur *registry*

Au sein de votre √©quipe ou de votre organisation, vous avez versionn√© votre `Dockerfile` et les fichiers utilis√©s
(pour rappel le `poetry.lock` et le `pyproject.toml`) permettant √† tous ceux ayant acc√®s √† votre *repository* de pouvoir
construire votre image et y rattacher un ou plusieurs container¬∑s.

De cette mani√®re, chaque personne qui va r√©cup√©rer le `Dockerfile` devra construire l'image de son c√¥t√©, donc chacun
fera les m√™mes actions et utilisera les m√™mes ressources r√©seaux. Par ailleurs, dans le cadre d'un CI/CD, il faudra √†
chaque fois reconstruire l'image et recharger les d√©pendances des diff√©rents d√©p√¥ts officiels.

Pour r√©pondre √† cette probl√©matique, on stocke l'image sur un *registry* afin de r√©cup√©rer l'image construite √† la
demande. L'image est *build√©e* une seule fois, puis d√©pos√©e sur le *registry*. Les personnes souhaitant r√©cup√©rer
l'image et les t√¢ches de CI/CD vont r√©cup√©rer l'image compl√®te depuis le *registry* et l'utiliser directement, sans
avoir besoin de la construire de leur c√¥t√©.

## 4.1 Docker Hub

Il existe plusieurs solutions de *registry* :

* `Docker Hub` : Solution officielle et publique de `Docker`.
* `Harbor` : Solution priv√©e et open-source de `VMWare`.
* `GitHub` et`GitLab` mettent √©galement une solution √† disposition.

Pour le cas de ce TP, vous allez utiliser `Docker Hub`.

Cr√©ez un compte √† partir de votre @ORT ou de votre compte GitHub et cr√©ez-vous un *repository* `3olen-tp-git-01-python`,
qui servira de repository pour votre image python de ce TP.

## 4.2 Push de l'image

Dans votre terminal, vous allez vous connecter √† votre compte Docker par la commande `docker login`.

Vous allez devoir modifier le nom de votre image pour qu'il corresponde au nom d'image de votre repository :

`3olen/tp-git-01-python` => `utilisateur_docker/3olen-tp-git-01-python`.

Par ailleurs, il faudra aussi d√©finir un tag √† cette image afin d'avoir une r√©f√©rence claire et pr√©cise et vous saurez
que ce tag (ou plut√¥t cette "version") correspond √† un √©tat particulier de votre image, en l'occurrence une image python
avec Poetry et la d√©pendence `psutil`.

Ceci va s'effectuer avec la commande `docker tag` :

```bash
# Remplacez "utilisateur_docker" par le nom de votre compte utilisateur
docker tag 3olen/tp-git-01-python utilisateur_docker/3olen-tp-git-01-python:1.0.0
```

Cette commande va cr√©er un nouveau nom (ou un nouveau tag si on garde le m√™me nom) de l'image "source" (√† partir d'un
tag, par d√©faut `latest`). Puisque le contenu des images (ou des tags) est identique, ils ont la m√™me r√©f√©rence. Vous
pouvez vous en rendre compte en listant vos images et vous remarquerez que "image ID" est la m√™me valeur sur les deux
lignes.

Dans ce cas, du coup, vous avez d√©fini une image correspondant au nom de votre repository et vous l'avez taggu√©e en
`1.0.0`, en vous basant sur l'image que vous manipuliez jusqu'√† pr√©sent (sur le tag `latest`).

Il ne reste plus qu'√† pousser cette image sur votre repository :

```bash
# Remplacez "utilisateur_docker" par le nom de votre compte utilisateur
docker push utilisateur_docker/3olen-tp-git-01-python:1.0.0
```

V√©rifiez ensuite sur la page de votre repository Docker Hub.

## 4.3 Utilisation de l'image du repository

Vous allez maintenant pouvoir remplacer vos utilisations de l'image `3olen/tp-git-01-python` par l'image de votre
repository (avec le tag pouss√©, bien s√ªr) :

1. Supprimez l'image locale de `3olen/tp-git-01-python`.
2. Supprimez √©galement l'image locale `utilisateur_docker/3olen-tp-git-01-python:1.0.0`, afin de pouvoir r√©cup√©rer
   l'image √† partir de votre repository.
3. Faites un "search and replace" global sur votre projet afin d'utiliser la nouvelle image :
   `utilisateur_docker/3olen-tp-git-01-python:1.0.0`.
4. V√©rifiez bien que l'image n'existe plus avec `docker images`.
5. Ex√©cutez la commande `python --version` dans un container utilisant l'image de votre repository :
   ```bash
   # Remplacez "utilisateur_docker" par le nom de votre compte utilisateur
   docker run --rm -it utilisateur_docker/3olen-tp-git-01-python:1.0.0 python --version
   ```

Docker devrait vous informer que l'image n'existe pas localement et qu'il doit aller la chercher depuis les repositories
qu'il conna√Æt. L'image est alors *pulled* depuis votre repository via le r√©seau et accessible en local comme si vous
l'aviez construite. Et, bien entendu, votre commande s'ex√©cute et vous obtenez la version de python.

Vous pourriez, par ailleurs, faire la m√™me chose avec l'image de n'importe lequel de vos camarades vu que nous avons
d√©fini un repository en "public".

Et au sein d'un *job* de CI/CD, vous n'aurez jamais √† construire les images, √©tant donn√© que les environnements
d'ex√©cution des t√¢ches CI/CD sont supprim√©es √† la vol√©e. Vous utiliserez un registry duquel vous r√©cup√©rez votre image.
