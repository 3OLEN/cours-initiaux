---
title: "Git - TP 1"
subtitle: "Automatisation : hooks et actions"
permalink: /git/tp/1/page/3
---

> Dans cette partie √©galement, vous travaillerez en pair-programming.

# 1. Automatisation des hooks

Comme vu pr√©c√©demment, il est n√©cessaire de copier les hooks versionn√©s dans le dossier `.git/hooks` pour qu'ils soient
pris en compte par Git. Cela poser des probl√®mes de maintenabilit√© et de synchronisation.

Un outil tel que [üê∂ Husky](https://typicode.github.io/husky/) permet d'automatiser cette t√¢che. C'est une librairie
Node.js qui pourra s'int√©grer assez "facilement" dans un projet web.

Or ce n'est pas forc√©ment notre cas et il n'est pas n√©cessaire de surcharger l'environnement avec du Node.

Git propose une solution native pour aider √† la synchronisation des hooks ; il s'agit d'une configuration :
`core.hooksPath`.

> **Remarque** : D'ailleurs, Husky repose sur l'utilisation de cette configuration.

## 1.1 üìãÔ∏è Instructions de la configuration Git

### Manipuler et tester la configuration `core.hooksPath`

1. Positionnez-vous sur la branche `main` et synchronisez votre d√©p√¥t local avec le d√©p√¥t distant (`git pull`).
2. R√©cup√©rez le pre-commit hook : `cp bin/hooks/pre-commit .git/hooks`.
3. Tentez un commit "√† vide" : `git commit -m "Test"`.
<br>Cette action doit √™tre refus√©e par le hook : `Interdiction de commiter sur la branche principale 'main' !`.
4. Supprimez les hooks personnalis√©s dans le `.git/hooks` : `rm .git/hooks/pre-commit .git/hooks/pre-push`.
5. Retentez le commit "√† vide". Vous devriez avoir un message natif √† Git vous indiquant qu'il n'y a rien √† commiter.
6. Configurez le chemin vers les hooks versionn√©s : `git config --local core.hooksPath bin/hooks`.
<br>Faites attention √† bien pr√©ciser l'option `--local`, vous ne voudriez pas que cette configuration sp√©cifique soit
d√©finie pour tous vos repositories.
7. Retentez de nouveau le commit "√† vide". Vous retrouvez le message d'erreur du hook personnalis√©.
8. Modifiez le fichier `bin/hooks/pre-commit` pour ajouter `error "Test !" && exit 1` √† la ligne 8
(apr√®s la fonction `error`).
9. Retentez une derni√®re fois le commit "√† vide". Vous devriez avoir votre message d'erreur `Test !`.
10. Annulez vos modifications : `git reset --hard`.

### Communiquer la proc√©dure

1. Cr√©ez la branche `local-hooks-config`.
2. Modifiez le fichier `README.md` pour compl√©ter la t√¢che `Hooks` en ajoutant ces deux lignes juste en-dessous :
<br><br>*‚ö†Ô∏è Attention √† bien garder les espaces en d√©but de ligne pour cr√©er une sous-liste.*
<br><br>
```markdown
  - [x] Utilisation des scripts versionn√©s.
  - [ ] Automatiser la configuration.
```
3. Modifiez aussi le fichier `README.md` au niveau de la partie `üìãÔ∏è Instructions du repository` pour ajouter la mise en
place de la configuration Git vue au-dessus.
<br>*Voir plus bas...*
4. Commitez ces modifications : `git commit -m "üìù [hooks] Git configuration"`.
5. Vous devriez conna√Ætre maintenant les instructions √† suivre ensuite.

#### Proposition de r√©daction du README.md

``````markdown
## üìãÔ∏è Instructions du repository
  
### Git - Configuration
  
```bash
# D√©finit le chemin vers les hooks versionn√©s.
git config --local core.hooksPath bin/hooks
```
``````

## 1.2. üìãÔ∏è Instructions de l'automatisation

On ne va pas exactement faire d'automatisation ; on va √©viter de faire une t√¢che manuelle, ce qui est une sorte 
d'automatisation, par le biais d'un script bash.

1. Cr√©ez la branche `local-setup-hooks`.
2. Cr√©ez le fichier `bin/setup/hooks` et ajoutez-y le contenu d√©fini ci-apr√®s.
3. Pensez √† rendre ce script ex√©cutable... Et n'oubliez pas de remplacer les `TODO` par le code ad√©quat.
4. Modifiez le fichier `README.md` pour cocher la deuxi√®me sous-t√¢che de `Hooks` d√©finie dans la partie pr√©c√©dente.
5. Modifiez de nouveau le fichier `README.md` pour remplacer ce qui avait √©t√© √©crit sur les instructions du repository
concernant la configuration Git. Toute la partie `Git - Configuration` peut √™tre remplac√©e par le contenu fourni
ci-apr√®s.
6. Commitez : `git commit -m "üî® [hooks] Setup script"`.
7. Pushez, cr√©ez la PR et **demandez-moi une review**.

#### üìù Contenu initial du script `bin/setup/hooks`

```bash
#!/bin/bash

set -eu

ROOT_PATH="$(realpath "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/../..")"
HOOKS_DIR="bin/hooks"
HOOKS_PATH="${ROOT_PATH}/${HOOKS_DIR}"

# 1. V√©rifie si la configuration locale est d√©finie
hooks_path_config=$(git config --local --get core.hooksPath || echo "")
# TODO: D√©finir la configuration locale sur la valeur de HOOKS_DIR
#   Si elle n'est pas d√©finie ou si la valeur est diff√©rente de HOOKS_DIR => ex√©cuter la commande correspondante
#   Pensez √† afficher un message pour informer de l'action effectu√©e
#   Par exemple : echo "Configuration locale 'core.hooksPath' d√©finie sur '${HOOKS_DIR}'"

# 2. V√©rifie si les hooks sont ex√©cutables
# TODO: Rendre chaque fichier hook ex√©cutable
#   Pensez √† ignorer les dossiers
#   Comme plus haut, affichez un message pour informer des actions effectu√©es
```

#### üìù Contenu du README.md √† remplacer

Ce contenu remplace la sous-partie `Git - Configuration` de la partie `üìãÔ∏è Instructions du repository`, puisqu'elle
n'est plus d'actualit√© gr√¢ce √† notre script.

```markdown
### Setup du repository

Les scripts d√©finis dans le dossier [bin/setup](bin/setup) sont des scripts de "setup" √† ex√©cuter une premi√®re fois
apr√®s le clonage du repository. Certains scripts peuvent √™tre lanc√©s √† nouveau pour prendre en compte certains
changements.

* [bin/setup/hooks](bin/setup/hooks) : Agit sur les hooks Git sp√©cifiques au repository.
  1. D√©finie la configuration locale pour utiliser les hooks versionn√©s.
  2. Rend les hooks ex√©cutables.
  - Ce script peut √™tre ex√©cut√© √† nouveau d√®s qu'un nouveau hook est ajout√© au repository afin de le rendre ex√©cutable. 
```


# 2. GitHub Actions

GitHub met √† disposition un outil d'automatisation permettant notamment de r√©aliser des t√¢ches de CI/CI :
[GitHub Actions](https://docs.github.com/fr/actions).

Il faut d√©finir des workflows qui seront ex√©cut√©s lors d'√©v√©nements sp√©cifiques (push, pull request, etc.). Ces
workflows int√®grent un ensemble de jobs qui sont eux-m√™mes compos√©s d'√©tapes.

Lorsqu'un √©v√©nement GitHub d√©clenche un workflow, celui-ci va ex√©cuter les jobs dans l'ordre d√©fini sur des machines
virtuelles mises √† disposition (appel√©es ¬´ runners ¬ª). Chaque job ex√©cute ses propres √©tapes.

D√®s lors qu'une √©tape √©choue, le job et le workflow associ√©s sont √©chus √©galement et l'√©v√©nement GitHub peut alors
s'interrompre compl√®tement tant que le probl√®me n'est pas r√©solu.

On peut, par exemple, emp√™cher un push sur une branche si les tests unitaires ne passent pas.

## 2.1 üìãÔ∏è Instructions de la prise en main de GitHub Actions

1) Cr√©ez la branche `ci-actions-quality-git`.

2) Modifiez le fichier `.editorconfig` pour ajouter une nouvelle r√®gle sur les fichiers `yaml` :

```ini
[*.yaml]
indent_size = 2
```

3) Cr√©ez un nouveau fichier `.github/workflows/quality.yaml` et ajoutez-y le contenu d√©fini suivant :

```yaml
name: Qualit√©
on: [pull_request]
jobs:
  git_standards:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: git fetch origin
      - name: V√©rification des commits de la branche
        run: "echo \"PR from: ${{ github.head_ref}} to: ${{ github.base_ref}}\""
```

4) Commitez vos modifications, cette fois avec un message plus complet :

```markdown
üë∑ [quality] Init

üë∑ GitHub Actions
=================

* Define new `workflow` to check defined Git standards

üêÅ EditorConfig
===============

* New rules for `yaml` files
```

5) Pushez et cr√©ez la PR sur GitHub.

GitHub prend alors en compte le workflow et l'ex√©cute : un cadre appara√Æt sur la PR pour indiquer que le workflow est en
cours d'ex√©cution et une nouvelle entr√©e appara√Æt dans l'onglet `Actions` du repository, correspondant √† l'ex√©cution de
l'ensemble des GitHub Actions g√©n√©r√©es par la PR.

6) V√©rifiez que le workflow s'est bien ex√©cut√©, qu'il n'y a pas d'erreur et que la *step* avec l'instruction `echo` a
bien affich√© le message attendu.

## 2.2 üìãÔ∏è Instructions du script ex√©cut√© par GitHub Actions

Maintenant, il faut √©crire le script qui va effectuer l'action "qualit√©" que l'on souhaite impl√©menter, √† savoir une
v√©rification du nombre de commits sur la branche √† merger, comme on l'avait fait avec les hooks.

L'environnement `Git` de la VM de GitHub √©tant un peu diff√©rent de celui de vos machines, le hook `pre-push` ne pourra
pas √™tre utilis√© tel quel. Il faut √©crire un script qui effectue la m√™me action, mais qui soit plus adapt√© √†
l'environnement de GitHub.

Il a fallu plusieurs essais pour arriver √† un script fonctionnel, donc je vous le donne directement.

{% assign resource_script_actions_quality_git = site.static_files | where: "name", "actions-quality-git-01" | first %}

1. R√©cup√©rez le fichier : [actions-quality-git-01]({{ resource_script_actions_quality_git | relative_url }}).
2. D√©placez-le dans le dossier `bin/actions/quality/git_standards` et renommez-le `branch-commits`.
3. Pensez √† rendre ce script ex√©cutable.
4. Modifiez la *step* `V√©rification des commits de la branche` du fichier `quality.yaml` pour ex√©cuter le script :
`run: bin/actions/quality/git_standards/branch-commits ${{ github.head_ref }}`.
<br>On fournit le nom de la branche √† merger en param√®tre du script gr√¢ce aux variables des contextes GitHub Actions.
<br>
<br>Bien s√ªr, vous remplacez l'instruction `echo` d√©finie pr√©c√©demment.
5. Rajoutez une clef `if` entre les clefs `runs-on` et `steps` du job afin d'ajouter une condition sur l'ex√©cution du
job : <br>`if: github.base_ref == github.event.repository.default_branch`.
<br><br>Cette condition permet de n'ex√©cuter le job que si la branche de destination est la branche principale du
repository.
6. Ajoutez ces changements au commit pr√©c√©dent : `git commit --amend --no-edit`.
7. Avant de pushez, n'oubliez pas la modification habituelle du `README.md` au sujet des t√¢ches √† faire / r√©alis√©es.
Rajoutez une nouvelle t√¢che √† la liste :
<br>``- [x] **GitHub Actions** : Initialisation du workflow `Quality` pour l'assurance qualit√© (QA).``.
8. Cette fois, cr√©ez un deuxi√®me commit pour tester le job.
<br>Pour rappel, l'option `--no-verify` permet de ne pas ex√©cuter les hooks lors d'un `git commit` ou d'un `git push`.
9. Vous devriez avoir 2 commits en local et donc 2 commits sur votre PR.
10. Le workflow s'ex√©cute de nouveau et cette fois √©choue √† l'√©tape `V√©rification des commits de la branche` avec le
message d'erreur `Vous avez plusieurs commits. [...]`.
11. Faites un rebase interactif en local pour *squasher* vos 2 commits en un seul. Ne gardez que le message du premier
commit.
12. Faites ensuite un `git push --force` pour forcer la mise √† jour de l'historique de la branche distante.
13. Le workflow devrait cette fois √™tre en succ√®s.
14. **Demandez-moi une review** pour valider tout √ßa.

# Pour la suite...

Vous vous √™tes familiaris√©s avec le scripting afin d'effectuer des actions manuelles ou d'ex√©cuter des v√©rifications
r√©p√©titives, notamment dans le cadre de l'int√©gration continue (CI) avec les GitHub Actions. Tout ceci est assez
sommaire et il sera n√©cessaire de vous investir personnellement pour mieux appr√©hender et manipuler ces sujets.

Dans la prochaine partie du TP, vous allez continuer √† utiliser le scripting pour mettre en place un environnement avec
l'aide de Docker.
