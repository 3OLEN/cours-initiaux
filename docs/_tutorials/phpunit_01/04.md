---
title: "PHPUnit - TP 1"
subtitle: "Assurer les bonnes pratiques du projet"
permalink: /phpunit/tp/1/page/4
---

Pour répondre à des problématiques de projet, les "tech" vont concevoir des solutions/réponses et les mettre en place
au sein de leur projet. Ces nouvelles pratiques mises en place dans le projet vont être partagées avec les autres et
avec les futurs intervenants, notamment par le biais d'une documentation.

Cependant, il est compliqué de s'assurer que chacun respecte ces pratiques ou les applique correctement.

On peut alors étendre l'utilisation des tests unitaires codés pour vérifier que certaines pratiques sont bien mises
en place et continuent à être utilisées au fil de l'évolution du projet.

# 1. Objectifs d'un DTO

Comme vu précédemment, un DTO est une classe qui doit répondre à ces contraintes :

* La seule utilisation de l'objet est de récupérer les données qu'il transporte.
* Ces données doivent être immuables, c'est-à-dire en lecture seule.
* L'objet ne doit pas mettre à disposition des méthodes publiques.
  <br>Si le besoin est de transformer les données, il faut utiliser un autre type d'objet, comme un `DataTransformer`.

Avec les évolutions de PHP, il est possible de répondre à ces contraintes par le biais des éléments suivants :

* Les propriétés doivent utiliser le mot-clef `readonly`, ce qui les rend immuables ; elles ne peuvent être modifiées
  qu'à l'instanciation de l'objet (dans le constructeur).
* Les propriétés doivent être publiques, ce qui permet de les récupérer sans avoir à utiliser de méthode.

Une fois ces règles définies, on peut s'assurer de leur mise en place à travers des tests unitaires et les
`ReflectionClass` de PHP, qui permettent de récupérer des informations sur une classe. C'est grâce à ces informations
que l'on va pouvoir mettre en place des tests qui vérifient que les règles de développement sont bien respectées.

[Lien vers la documentation PHP des `ReflectionClass`](https://www.php.net/manual/fr/class.reflectionclass.php).

## 1.1 Tester les propriétés

Vous allez compléter vos tests unitaires sur le `MediaDto` afin de vérifier que toutes les propriétés de la classe sont
définies comme `readonly` et `public`.

{% 
  include templates/components/_hint.liquid
  content="Jetez un œil à la méthode `ReflectionClass::getProperties()` et à la classe `ReflectionProperty`..."
%}

Ce test devrait alors vous ajouter `4 x 2` assertions (4 propriétés, 2 assertions différentes).

Rajoutez maintenant une propriété privée dans le DTO et une propriété publique, mais pas en lecture seule (il faudra
faire quelques ajustements sur la classe pour pouvoir le faire).

Profitez-en pour supprimer vos tests sur le constructeur, qui ne sont plus utiles.

Vérifiez que phpunit remonte **deux** failures. S'il n'y en a qu'une, vous devriez sûrement utiliser un Data Provider
plutôt qu'une boucle `foreach` dans votre test...

Faites un *revert* de vos modifications sur la classe `MediaDto` afin que vos tests soient à nouveau au vert.

## 1.2 Tester les méthodes

Vous allez compléter vos tests unitaires sur le `MediaDto` afin de vérifier que la classe ne met à disposition aucune
méthode définies comme `public`.

{% 
  include templates/components/_hint.liquid
  content="Jetez un œil à la méthode `ReflectionClass::getMethods()` et à la classe `ReflectionMethod`..."
%}

> ⚠️ Le constructeur est une méthode définie comme `public`, elle doit être autorisée dans ce test.
> <br>Lorsque vous êtes dans ce cas de figure, utilisez l'instruction `$this->addToAssertionCount(count: 1);` afin
> d'indiquer qu'une assertion a été faite.

Ce test devrait alors vous ajouter une assertion supplémentaire.

Rajoutez maintenant trois méthodes dans votre DTO pour `public`, `protected` et `private`. Vérifiez que phpunit rajoute
trois assertions supplémentaires dont une en échec.

Faites un *revert* de vos modifications sur la classe `MediaDto` afin que vos tests soient à nouveau au vert.

## 2. Tester **tous** les DTOs

Vous avez écrit des tests pour une classe `DTO`, ce qui signifie qu'il faudrait faire la même chose pour toutes les
classes `DTO` du projet. Par ailleurs, vous devez vous assurer que chaque nouveau `DTO` aura des tests unitaires.

Cela semble être une tâche répétitive et fastidieuse, qui a de fortes probabilités d'être oubliée au fil du temps.

Vous allez donc créer un test applicable à l'ensemble des classes `DTO` du projet, c'est-à-dire toutes les classes
correspondant au pattern `*Dto.php` et incluses dans le namespaces `TroisOlen\PhpunitTp\Model` (ou dans le dossier
`src/Model/`).

Vous devriez alors avoir trois tests pour les méthodes (correspondant au constructeur des trois DTOs existants) et
neuf tests (soit dix-huit assertions) pour les propriétés (trois pour le `AnswerDto`, deux pour le `QuoteDto` et
quatre pour le `MediaDto`).

Une fois ces tests écrits et valides, vous pouvez supprimer la classe de test sur `MediaDto`, qui a été remplacée par
vos nouveaux tests.
